# React Compiler 簡介

## 什麼是 React Compiler

React Compiler（React 編譯器）是 React 團隊於 2024 年推出的一項重要工具，旨在通過編譯時優化提升 React 應用的性能和開發體驗。

### 核心功能

React Compiler 在構建階段分析和轉換代碼，自動應用性能優化，主要包括：

- **自動記憶化（Automatic Memoization）**：自動為組件和 Hook 添加 `memo`、`useMemo`、`useCallback` 等優化，無需手動編寫
- **副作用管理**：智能分析依賴關係，優化 `useEffect`、`useMemo`、`useCallback` 的依賴陣列
- **減少重新渲染**：通過靜態分析識別不必要的重新渲染，自動優化組件更新邏輯
- **編譯時優化**：在構建階段完成優化，不增加運行時開銷

### 為什麼需要 React Compiler

傳統的 React 優化需要開發者手動：
- 使用 `React.memo` 包裹組件
- 使用 `useMemo` 和 `useCallback` 記憶化值和函數
- 仔細管理依賴陣列

這些手動優化容易出錯，且增加了代碼複雜度。React Compiler 通過編譯時分析，自動完成這些優化，讓開發者可以專注於業務邏輯。

---

## 安全性

### 生產環境穩定性

React Compiler 已進入穩定階段，並在生產環境中經過廣泛測試：

- **Meta 內部使用**：Meta（Facebook）已在其生產環境中廣泛使用 React Compiler
- **大規模驗證**：經過數百萬用戶的實際應用驗證
- **穩定版本**：已發布穩定版本，可用於生產環境

### 使用建議

雖然 React Compiler 已經穩定，但在部署到生產環境前，建議：

1. **檢查代碼庫狀況**：確保代碼遵循 React 規則（Rules of React）
2. **測試驗證**：在開發和測試環境中充分驗證編譯器行為
3. **監控性能**：部署後監控應用性能指標，確保優化效果符合預期
4. **逐步採用**：建議採用漸進式方式引入，而非一次性全量啟用

### 潛在風險

- **代碼不符合 React 規則**：如果代碼違反 React 規則（如 Hook 規則、不可變性等），編譯器可能無法正確優化
- **第三方庫兼容性**：某些第三方庫可能與編譯器不完全兼容
- **構建工具配置**：需要正確配置構建工具以支持編譯器

---

## 兼容性

### React 版本支持

React Compiler 設計用於與 **React 19** 配合使用，同時也支持：

- **React 17**：完全支持
- **React 18**：完全支持
- **React 19**：最佳支持，推薦使用

### 構建工具支持

React Compiler 可以集成到多個構建工具中：

- **Babel**：通過 `babel-plugin-react-compiler` 插件
- **Vite**：通過 Vite 插件支持
- **Metro**：React Native 的構建工具
- **Rsbuild**：支持
- **swc**：正在開發中（與 swc 團隊合作）
- **oxc**：正在開發中（與 oxc 團隊合作）

### 框架支持

- **Next.js**：官方支持，可通過配置啟用
- **Remix**：支持
- **Create React App**：支持
- **React Native**：通過 Metro 支持

### 瀏覽器兼容性

React Compiler 是編譯時工具，不影響運行時瀏覽器兼容性。編譯後的代碼與標準 React 代碼具有相同的瀏覽器支持要求。

---

## 安裝與使用

### 前置要求

在安裝 React Compiler 之前，確保：

- **Node.js**：版本 18 或更高
- **React**：版本 17、18 或 19
- **構建工具**：支持 Babel 或相關插件

### 安裝步驟

#### 1. 安裝 Babel 插件

React Compiler 主要通過 Babel 插件提供支持。使用你喜歡的包管理器安裝：

```bash
# 使用 npm
npm install -D babel-plugin-react-compiler@latest

# 使用 yarn
yarn add -D babel-plugin-react-compiler@latest

# 使用 pnpm
pnpm install -D babel-plugin-react-compiler@latest
```

#### 2. 安裝 React Compiler 運行時（可選）

如果需要運行時支持（如開發模式下的調試信息），可以安裝：

```bash
npm install react-compiler-runtime
```

### 配置方法

#### 方法一：使用 Babel（通用方法）

##### 創建或更新 `babel.config.js`

```javascript
module.exports = {
  plugins: [
    // React Compiler 必須在其他插件之前運行
    ['babel-plugin-react-compiler', {
      // 可選配置項
      compilationMode: 'annotation', // 或 'infer'
      runtimeModule: 'react-compiler-runtime',
    }],
    // 其他 Babel 插件
    '@babel/preset-react',
    '@babel/preset-env',
  ],
};
```

##### 或使用 `babel.config.json`

```json
{
  "plugins": [
    ["babel-plugin-react-compiler", {
      "compilationMode": "annotation"
    }]
  ]
}
```

**重要提示**：React Compiler 插件必須在 Babel 插件陣列中**第一個**位置，這樣才能正確分析原始源代碼。

#### 方法二：在 Vite 中使用

##### 選項 A：通過 `@vitejs/plugin-react` 配置

```javascript
// vite.config.js
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [
    react({
      babel: {
        plugins: [
          ['babel-plugin-react-compiler', {
            compilationMode: 'annotation',
          }],
        ],
      },
    }),
  ],
});
```

##### 選項 B：使用 `vite-plugin-babel`（獨立插件）

```bash
npm install -D vite-plugin-babel
```

```javascript
// vite.config.js
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import babel from 'vite-plugin-babel';

export default defineConfig({
  plugins: [
    react(),
    babel({
      babelConfig: {
        plugins: [
          ['babel-plugin-react-compiler', {
            compilationMode: 'annotation',
          }],
        ],
      },
    }),
  ],
});
```

#### 方法三：在 Next.js 中使用

##### Next.js 15+（推薦）

Next.js 15 及更高版本提供內置支持：

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactCompiler: true, // 直接啟用
  // 或使用配置對象
  // reactCompiler: {
  //   compilationMode: 'annotation',
  // },
};

module.exports = nextConfig;
```

##### Next.js 14 及更早版本

對於較舊版本的 Next.js，需要通過 Babel 配置：

1. 安裝插件：
```bash
npm install -D babel-plugin-react-compiler
```

2. 創建或更新 `babel.config.js`：
```javascript
module.exports = {
  presets: ['next/babel'],
  plugins: [
    ['babel-plugin-react-compiler', {
      compilationMode: 'annotation',
    }],
  ],
};
```

**注意**：在 Next.js 中使用 Babel 插件可能會增加構建時間。建議升級到 Next.js 15+ 以獲得更好的性能。

#### 方法四：在 Create React App 中使用

Create React App 需要通過 `react-app-rewired` 或 `craco` 來覆蓋配置。

##### 使用 CRACO（推薦）

1. 安裝依賴：
```bash
npm install -D @craco/craco babel-plugin-react-compiler
```

2. 創建 `craco.config.js`：
```javascript
module.exports = {
  babel: {
    plugins: [
      ['babel-plugin-react-compiler', {
        compilationMode: 'annotation',
      }],
    ],
  },
};
```

3. 更新 `package.json` 腳本：
```json
{
  "scripts": {
    "start": "craco start",
    "build": "craco build",
    "test": "craco test"
  }
}
```

#### 方法五：在 React Native（Metro）中使用

1. 安裝插件：
```bash
npm install -D babel-plugin-react-compiler
```

2. 更新 `babel.config.js`：
```javascript
module.exports = {
  presets: ['module:metro-react-native-babel-preset'],
  plugins: [
    ['babel-plugin-react-compiler', {
      compilationMode: 'annotation',
    }],
  ],
};
```

#### 方法六：在 Remix 中使用

1. 安裝插件：
```bash
npm install -D babel-plugin-react-compiler
```

2. 更新 `remix.config.js` 或創建 `babel.config.js`：
```javascript
module.exports = {
  plugins: [
    ['babel-plugin-react-compiler', {
      compilationMode: 'annotation',
    }],
  ],
};
```

### 配置選項

React Compiler Babel 插件支持以下配置選項：

```javascript
{
  plugins: [
    ['babel-plugin-react-compiler', {
      // 編譯模式
      // 'annotation': 僅編譯帶有 "use memo" 註釋的組件（漸進式採用）
      // 'infer': 自動推斷所有組件（全量啟用）
      compilationMode: 'annotation', // 默認值

      // 運行時模組（可選）
      runtimeModule: 'react-compiler-runtime',

      // 源文件路徑（用於錯誤報告）
      sources: (filename) => true, // 函數，返回是否處理該文件

      // 目標文件路徑（用於輸出）
      target: 'react', // 'react' 或 'react-native'

      // 環境變數
      environment: 'development', // 'development' 或 'production'
    }],
  ],
}
```

### 使用註釋控制編譯

#### 啟用編譯（漸進式採用）

在組件或 Hook 上添加 `"use memo"` 註釋來啟用編譯器優化：

```javascript
// "use memo"
function MyComponent({ name, age }) {
  const [count, setCount] = useState(0);
  
  const expensiveValue = useMemo(() => {
    return computeExpensiveValue(name, age);
  }, [name, age]);
  
  return <div>{expensiveValue}</div>;
}
```

#### 禁用編譯

使用 `"no memo"` 註釋跳過編譯器優化：

```javascript
// "no memo"
function LegacyComponent() {
  // 這個組件不會被編譯器優化
  return <div>Legacy Code</div>;
}
```

### 驗證安裝

#### 1. 檢查構建輸出

運行構建命令，檢查是否有編譯器相關的輸出：

```bash
npm run build
```

如果配置正確，構建應該成功完成，且不會有編譯器相關的錯誤。

#### 2. 使用 React DevTools

1. 安裝 [React DevTools](https://react.dev/learn/react-developer-tools)
2. 打開瀏覽器開發者工具
3. 切換到 React DevTools
4. 查看組件樹，優化過的組件旁邊會顯示 **"Memo ✨"** 徽章

#### 3. 檢查控制台

在開發模式下，編譯器可能會輸出調試信息。檢查瀏覽器控制台是否有相關日誌。

#### 4. 性能測試

使用 React DevTools Profiler 測試應用性能，驗證編譯器是否正常工作：

1. 打開 React DevTools
2. 切換到 Profiler 標籤
3. 開始記錄
4. 與應用交互
5. 停止記錄並分析結果

### 基本使用示例

#### 示例 1：自動記憶化組件

```javascript
// 編譯前（需要手動優化）
function ProductList({ products, filter }) {
  const filteredProducts = products.filter(p => 
    p.name.includes(filter)
  );
  
  return (
    <ul>
      {filteredProducts.map(product => (
        <ProductItem key={product.id} product={product} />
      ))}
    </ul>
  );
}

// 編譯後（自動優化）
// React Compiler 會自動記憶化 filteredProducts
// 並優化 ProductItem 組件的重新渲染
```

#### 示例 2：自動優化 Hook 依賴

```javascript
// "use memo"
function UserProfile({ userId }) {
  const [user, setUser] = useState(null);
  
  useEffect(() => {
    fetchUser(userId).then(setUser);
    // 編譯器會自動確保依賴陣列正確
  }, [userId]);
  
  return user ? <div>{user.name}</div> : <div>Loading...</div>;
}
```

#### 示例 3：條件渲染優化

```javascript
// "use memo"
function ConditionalComponent({ show, data }) {
  // 編譯器會優化條件渲染邏輯
  if (!show) {
    return null;
  }
  
  return <ExpensiveComponent data={data} />;
}
```

### 常見問題排查

#### 問題 1：構建失敗

**症狀**：構建時出現編譯器相關錯誤

**解決方案**：
- 確保 `babel-plugin-react-compiler` 已正確安裝
- 檢查 Babel 配置，確保插件在正確位置
- 查看錯誤訊息，檢查是否有 React 規則違規

#### 問題 2：編譯器未生效

**症狀**：組件沒有顯示 "Memo ✨" 徽章

**解決方案**：
- 確認構建工具配置正確
- 檢查是否使用了 `compilationMode: 'annotation'` 但未添加 `"use memo"` 註釋
- 清除構建緩存並重新構建

#### 問題 3：性能未改善

**症狀**：啟用編譯器後性能沒有明顯提升

**解決方案**：
- 使用 React DevTools Profiler 分析具體瓶頸
- 檢查是否有大量不符合 React 規則的代碼
- 確認編譯器實際在處理你的組件

#### 問題 4：與第三方庫衝突

**症狀**：某些第三方庫出現異常行為

**解決方案**：
- 使用 `"no memo"` 註釋跳過有問題的組件
- 檢查第三方庫是否遵循 React 規則
- 聯繫庫維護者或查看是否有已知問題

### 開發工具支持

#### ESLint 插件（可選）

安裝 ESLint 插件以獲得更好的開發體驗：

```bash
npm install -D eslint-plugin-react-compiler
```

在 `.eslintrc.js` 中配置：

```javascript
module.exports = {
  plugins: ['react-compiler'],
  rules: {
    'react-compiler/react-compiler': 'error',
  },
};
```

### 生產環境部署

#### 1. 構建優化

確保生產構建啟用所有優化：

```javascript
// babel.config.js
module.exports = {
  plugins: [
    ['babel-plugin-react-compiler', {
      compilationMode: process.env.NODE_ENV === 'production' 
        ? 'infer' 
        : 'annotation',
      environment: process.env.NODE_ENV,
    }],
  ],
};
```

#### 2. 監控和日誌

在生產環境中：
- 監控錯誤率
- 追蹤性能指標
- 設置告警機制

#### 3. 回滾計劃

準備快速回滾方案：
- 通過環境變數控制編譯器啟用
- 使用功能標記（Feature Flags）
- 保持舊版本構建可用

---

## 漸進式使用

### 為什麼要漸進式採用

對於現有項目，建議逐步採用 React Compiler，原因包括：

1. **降低風險**：逐步引入可以及時發現和解決問題
2. **驗證效果**：在部分代碼中驗證編譯器的優化效果
3. **團隊適應**：給團隊時間適應新的構建流程
4. **問題隔離**：如果出現問題，可以快速定位和回滾

### 漸進式採用策略

#### 1. 從新功能開始

在新增功能或組件中啟用編譯器，驗證其行為和性能：

```javascript
// 新組件中啟用編譯器
// 通過構建工具配置，僅對特定目錄啟用
```

#### 2. 按模組逐步擴展

將應用劃分為模組，逐個模組啟用編譯器：

```
src/
  ├── components/     # 先啟用
  ├── pages/          # 然後啟用
  ├── hooks/          # 接著啟用
  └── utils/          # 最後啟用
```

#### 3. 使用標記控制

通過註釋或配置標記控制哪些代碼使用編譯器：

```javascript
// "use memo" - 告訴編譯器優化此組件
function MyComponent() {
  // ...
}

// "no memo" - 告訴編譯器跳過此組件
function LegacyComponent() {
  // ...
}
```

#### 4. 監控和驗證

在每個階段：

- **性能監控**：使用 React DevTools Profiler 監控性能變化
- **功能測試**：確保所有功能正常工作
- **錯誤追蹤**：監控錯誤日誌，及時發現問題
- **用戶反饋**：收集用戶反饋，驗證體驗改善

### 遷移步驟

1. **準備階段**
   - 檢查代碼是否符合 React 規則
   - 修復已知的 React 規則違規
   - 設置構建工具配置

2. **測試階段**
   - 在開發環境啟用編譯器
   - 運行完整測試套件
   - 進行手動測試

3. **小範圍部署**
   - 選擇低風險模組啟用
   - 部署到測試環境
   - 監控性能和錯誤

4. **逐步擴展**
   - 根據測試結果決定是否擴展
   - 逐個模組啟用編譯器
   - 持續監控和優化

5. **全量啟用**
   - 所有模組啟用編譯器
   - 移除臨時配置和標記
   - 文檔化最佳實踐

### 回滾策略

如果遇到問題，可以：

1. **快速回滾**：通過構建配置快速禁用編譯器
2. **部分回滾**：僅回滾有問題的模組
3. **問題修復**：修復問題後重新啟用

### 最佳實踐

- **版本控制**：使用 Git 分支管理漸進式遷移
- **文檔記錄**：記錄每個階段的配置和發現的問題
- **團隊溝通**：確保團隊了解遷移進度和注意事項
- **性能基準**：建立性能基準，量化優化效果

---

## 總結

React Compiler 是一個強大的工具，可以自動優化 React 應用性能，減少開發者的手動優化工作。通過：

- **理解其功能**：了解編譯器如何自動優化代碼
- **確保安全性**：在生產環境使用前充分測試
- **檢查兼容性**：確認 React 版本和構建工具支持
- **漸進式採用**：逐步引入，降低風險

可以安全有效地將 React Compiler 集成到現有項目中，提升應用性能和開發體驗。

---

## 參考資源

- [React Compiler 官方文檔](https://react.dev/learn/react-compiler)
- [React Compiler 漸進式採用指南](https://react.dev/learn/react-compiler/incremental-adoption)
- [React Compiler 配置指南](https://react.dev/learn/react-compiler/configuration)
- [React 規則（Rules of React）](https://react.dev/learn/escape-hatches#rules-of-react)
